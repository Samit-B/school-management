<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Student Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        /* Main Content */
.main-content {
    margin-left: 260px;
    padding: 20px;
    min-height: 100vh;
    background-color: #6ed5d3;
}

/* Cards */
.card {
    background-color: rgb(189, 230, 242);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease-in-out;
}



/* Event List */
#eventList {
    list-style: none;
    padding: 10px;
    margin-top: 10px;
}

#eventList li {
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 6px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#eventList li button {
    background-color: #e53e3e;
    color: white;
    padding: 6px;
    border-radius: 5px;
    transition: background 0.3s ease-in-out;
}

#eventList li button:hover {
    background-color: #c53030;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .main-content {
        margin-left: 0;
        padding: 15px;
    }
}

@media (max-width: 768px) {
    .grid-cols-3 {
        grid-template-columns: 1fr !important;
    }

    #chatbot-container {
        width: 90%;
        right: 5%;
    }
}
    </style>
</head>
<body>

    {% include 'sidebar.html' %}

    <div class="main-content">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">📊 Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">📊Total Students by Gender</h2>
                <canvas id="pieChart"></canvas>

                <div class="mt-4 text-center">
                    <p class="text-lg font-semibold">Total Students: <span id="totalStudents" class="font-bold"></span></p>
                    <div class="flex justify-between mt-2">
                        <p class="text-green-600 font-medium">Male: <span id="maleCount" class="font-bold"></span></p>
                        <p class="text-red-600 font-medium">Female: <span id="femaleCount" class="font-bold"></span></p>
                        <p class="text-yellow-600 font-medium">Others: <span id="othersCount" class="font-bold"></span></p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">🏫 Students by Class</h2>
                <canvas id="barChart"></canvas>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 text-center mb-4">📅 Calendar</h2>
                <input type="text" id="calendarInput" class="w-full p-2 border rounded-md text-center" placeholder="Select Date">
                
                <div class="mt-4">
                    <input type="text" id="eventTitle" class="w-full p-2 border rounded-md" placeholder="Event Title">
                    
                    <button onclick="addEvent()" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-md">Add Event</button>
                </div>
                
                <ul id="eventList" class="mt-4 bg-white p-4 rounded-md shadow-md">
                </ul>
            </div>
        </div>
    </div>
    <ul id="eventList" class="mt-4 bg-white p-4 rounded-md shadow-md">
    </ul>
    

    <script>
        document.addEventListener("DOMContentLoaded", function () {


            document.getElementById("logout-button").addEventListener("click", function (event) {
                event.preventDefault();
                fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        alert('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                });
            });
        });

        async function loadCharts() {
            try {
                let genderResponse = await fetch("/students/gender");
                let students = await genderResponse.json();

                let genderCounts = { male: 0, female: 0, others: 0 };

                students.forEach(student => {
                    let gender = student.gender.toLowerCase();
                    if (gender === "male") genderCounts.male++;
                    else if (gender === "female") genderCounts.female++;
                    else genderCounts.others++;
                });

                document.getElementById("totalStudents").textContent = students.length;
                document.getElementById("maleCount").textContent = genderCounts.male;
                document.getElementById("femaleCount").textContent = genderCounts.female;
                document.getElementById("othersCount").textContent = genderCounts.others;

                let ctxPie = document.getElementById("pieChart").getContext("2d");
                new Chart(ctxPie, {
                    type: "pie",
                    data: {
                        labels: ["Male", "Female", "Others"],
                        datasets: [{
                            data: [genderCounts.male, genderCounts.female, genderCounts.others],
                            backgroundColor: ["#4CAF50", "#FF5722", "#FFC107"],
                            hoverBackgroundColor: ["#388E3C", "#F44336", "#FF9800"]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return tooltipItem.label + ": " + tooltipItem.raw;
                                    }
                                }
                            }
                        }
                    }
                });

                let classResponse = await fetch("/students/student_class");
                let classData = await classResponse.json();

                let classCounts = {};
                classData.forEach(student => {
                    let studentClass = student.student_class.toString();
                    classCounts[studentClass] = (classCounts[studentClass] || 0) + 1;
                });

                let classLabels = Object.keys(classCounts);
                let classValues = Object.values(classCounts);

                let ctxBar = document.getElementById("barChart").getContext("2d");
                new Chart(ctxBar, {
                    type: "bar",
                    data: {
                        labels: classLabels,
                        datasets: [{
                            label: "Number of Students",
                            data: classValues,
                            backgroundColor: "#3498db",
                            borderColor: "#2980b9",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

            } catch (error) {
                console.error("Error loading charts:", error);
            }
        }

        window.onload = loadCharts;

        document.addEventListener("DOMContentLoaded", function () {
            flatpickr("#calendarInput", {
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                inline: true
            });
        });

       

        async function loadEvents() {
            let response = await fetch("/eventss");
            let events = await response.json();

            let eventList = document.getElementById("eventList");
            eventList.innerHTML = "";

            events.forEach(event => {
                let listItem = document.createElement("li");
                listItem.classList.add("flex", "justify-between", "items-center", "p-2", "border", "rounded-md", "mb-2");

                listItem.innerHTML = `
                    <span>${event.date} - ${event.title}</span>
                    <button onclick="delete_event(this, '${event.id}')"" class="bg-red-500 text-white px-2 py-1 rounded">❌</button>
                `;
                eventList.appendChild(listItem);
            });
        }

        document.addEventListener("DOMContentLoaded", loadEvents);

        async function delete_event(button, event_id) {
            if (confirm("Are you sure you want to delete this student?")) {
                let response = await fetch(`/eventss/${event_id}`, { method: "POST" });
                let result = await response.json();
                alert(result.message);

                if (response.ok) {
                    location.reload(); // Reload the page after successful deletion
                }
            }
        }

    </script>
    <script src="{{ url_for('static', path='main.js') }}"></script>

   
</body>

</html>
